<%-- 
    Document   : forum
    Created on : 1 Dec, 2014, 3:22:09 PM
    Author     : breakthesec
--%>

<%@page import="java.sql.Connection"%>
<%@page import="java.sql.SQLException"%>
<%@ page import="java.sql.PreparedStatement" %>
<%@ page import="java.sql.Statement" %>
<%@page import="java.sql.ResultSetMetaData"%>
<%@page import="java.sql.ResultSet"%>
<%@ page import="java.util.*,java.io.*"%>
<%@ page import="org.cysecurity.cspf.jvl.model.DBConnect"%>
<%@ page import="org.apache.commons.text.StringEscapeUtils"%>


 

<%@page contentType="text/html" pageEncoding="UTF-8"%>
 
  <%@ include file="/header.jsp" %>
<%
         Connection con=new DBConnect().connect(getServletContext().getRealPath("/WEB-INF/config.properties"));
               if(session.getAttribute("isLoggedIn")!=null && session.getAttribute("isLoggedIn").equals("1"))
               {
            	   String _user =StringEscapeUtils.escapeHtml4( (String) session.getAttribute("user")); 
                   out.print("Hello "+_user+", Welcome to Our Forum !");
               }
     %>
     <br/>  <br/>
        <h3>Create Post:</h3>
       <form action="forum.jsp" method="POST">
       Title : <input type="text" name="title" value="" size="50"/><br/>
       Message: <br/><textarea name="content" rows="2" cols="50"></textarea>
       <input type="hidden" name="user" value="<% if(session.getAttribute("user")!=null){out.print(StringEscapeUtils.escapeHtml4( (String) session.getAttribute("user")));} else { out.print("Anonymous"); } %>" size="50"/><br/>
       <input type="submit" value="Post" name="post"/>
       </form>

<br/>
<%
	response.setHeader("X-Frame-Options", "DENY"); 
	response.setHeader("X-Content-Type-Options","nosniff");
	response.setHeader("Cache-Control","no-cache, no-store, must-revalidate");
	response.setHeader("Pragma" ,"no-cache");
	response.setHeader("X-XSS-Protection","1");
                                    
     if(request.getParameter("post")!=null) 
                                 {
                                    String user=request.getParameter("user");
                                    String content=request.getParameter("content");
                                    String title=request.getParameter("title");
                                    if(con!=null && !con.isClosed())
                                        {
                                           //Statement stmt = con.createStatement();
                                           
                                           //Posting Content - the right way to build and execute SQL Statements
                                           PreparedStatement pstmt = con.prepareStatement("INSERT into posts(content,title,user) values"
                                        		  +"(?,?,?)"  
                                        	);
                                           
                                        	pstmt.setString(1, content);
                                        	pstmt.setString(2, title);
                                        	pstmt.setString(3,user);
                                        	pstmt.executeUpdate();
                                        	
                                           //Posting Content vulnerable way
                                          //pstmt.executeUpdate("INSERT into posts(content,title,user) values ('"+content+"','"+title+"','"+user+"')");
                                            out.print("Successfully posted");
                                        }
                                    }
                                                                    
    %>
     <h3>List of Posts:</h3> 
    <%
      if(con!=null && !con.isClosed())
          {
             Statement stmt = con.createStatement();
             ResultSet rs =null;
             rs=stmt.executeQuery("select * from posts");
             out.println("<table border='1'>");
             while (rs.next()) 
            {
                out.print("<tr>");
                String postid = StringEscapeUtils.escapeHtml4(rs.getString("postid"));
                String title = StringEscapeUtils.escapeHtml4(rs.getString("title"));
                
                
                out.print("<td><a href='forumposts.jsp?postid="+postid+"'>"+title+"</a></td>");
                out.print("<td> - Posted By ");
                
                String user = StringEscapeUtils.escapeHtml4(rs.getString("user"));
                
                if(!user.equalsIgnoreCase("anonymous"))
                {
                out.print("<a href='UserDetails.jsp?username="+user+"'>"+user+"</a>");
                }
                else
                {
                    out.print(user);
                }
                out.println("</td></tr>");
                
            }
            out.println("</table>");
       }
        out.print("<br/> <a href='forumUsersList.jsp'>Forum Users list &gt;&gt;</a>");                                     
     %>
       <%@ include file="/footer.jsp" %>